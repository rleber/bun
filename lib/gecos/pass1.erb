%# TODO Add play name directive
%# TODO Refactor out common code
%# TODO Add Stage Directions
%# TODO Add Lighting Directions
%# TODO Add general notes

<%
    $characters = {}
    $acts = []
    $play = nil
    
    def err(message)
      raise Fass::Script::ScriptError, message
    end
    
    def play(name)
      err "Attempt to redefine play" unless $play.nil?
      $play = name
    end
    
    def split_scene(number)
      if number.is_a?(Numeric)
        act, scene = number.divmod(1.0)
        while (scene.to_i - scene).abs > 0.05
          scene *= 10
        end
        scene = scene.to_i
      else
        err "Bad scene number #{number}" unless number =~ /^\s*(\d+)\s*(?:\.|:)\s*(\d+)\s*$/
        act, scene = [$1, $2].map{|s| s.to_i}
      end
      err "Invalid act number #{act}" if act<=0
      err "Invalid scene number #{scene}" if scene<=0
      [act, scene]
    end
    
    # TODO Allow for scene zero, if overridden
    # TODO Allow of scenes like "3a", "3b"
    # TODO Allow scenes to have names
    def scene(number, &block)
      act, scene = split_scene(number)
      $acts[act] ||= []
      $acts[act][scene] = {}
      Ember::Template.wrap_content_block(block) do |content|
        content
      end
    end
    
    # TODO Allow "played by"
    def character(nickname, fullname)
      $characters[nickname] = {:nickname=>nickname, :full_name=>fullname, :line_count=>0}
    end
    
    # TODO Allow for multiple characters to have the same lines
    # TODO Allow for spaces in nicknames
    # TODO Warn for unmatched names
    def line(nickname, options={}, &block)
      err "Character #{nickname} not defined" unless $characters[nickname]
      Ember::Template.wrap_content_block(block) do |content|
          content
      end
    end
    
    def rev(original, revised)
        revised
    end
    
    def song(title, tune, &block)
      Ember::Template.wrap_content_block(block) do |content|
        ["Song: #{title}\n",
        "To the tune of: #{tune}\n"] +
        content
      end
    end
    
    def direction(options={}, &block)
      Ember::Template.wrap_content_block(block) do |content|
          content
      end
    end
    
    def note(options={}, &block)
      Ember::Template.wrap_content_block(block) do |content|
          content
      end
    end
    
    def characters
      []
    end
-%>